<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Чат — {{ other.username }}</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    #chat-window::-webkit-scrollbar { display: none; }
    #chat-window { -ms-overflow-style: none; scrollbar-width: none; }

    .msg-appear { animation: appear .12s ease-out; }
    @keyframes appear { from { opacity: 0; transform: translateY(6px);} to { opacity:1; transform:none;} }

    .bubble,
    #chat-window .max-w-xs {
      display: inline-block !important;
      width: auto !important;
      max-width: min(70%, 680px) !important;
      padding: 0.5rem 1rem !important;
      line-height: 1.4 !important;
      word-break: break-word !important;
      vertical-align: bottom !important;
      box-sizing: border-box !important;
      border-radius: 0.9rem !important;
    }

    .bubble-incoming { background: #fff; border: 1px solid #e6e6e6; color: #111827; border-bottom-left-radius: 0.25rem; }
    .bubble-outgoing { background: #0095f6; color: #fff; border-bottom-right-radius: 0.25rem; }

    .msg-row { align-items: flex-end; }

    .chat-input { height: 3rem; }
    .btn-send { height: 3rem; width: 3rem; min-width: 3rem; display: inline-flex; align-items: center; justify-content: center; }

    body { background: linear-gradient(180deg,#fafafa 0%, #f3f4f6 100%); }
  </style>
</head>
<body class="antialiased text-slate-800">

  <div class="min-h-screen h-screen w-full flex items-stretch">
    <div class="flex-1 flex flex-col">
      <header class="flex items-center justify-between px-4 py-3 border-b bg-white">
        <div class="flex items-center gap-3">
          <a href="{% url 'direct:inbox' %}" class="md:hidden p-1 rounded hover:bg-gray-100" aria-label="Назад">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </a>

          <div class="h-10 w-10 rounded-full bg-gradient-to-tr from-pink-400 to-yellow-400 flex items-center justify-center text-white font-semibold">
            {{ other.username|first|upper }}
          </div>
          <div class="font-semibold">{{ other.username }}</div>
        </div>

        <div style="width:36px; height:36px;"></div>
      </header>

      <main id="chat-window" class="flex-1 overflow-y-auto space-y-4 p-6 bg-[color:rgba(250,250,250,1)]">
        {# Сервер-рендерені повідомлення (залишаю як є) #}
        {% for msg in messages %}
          {% if msg.sender == request.user %}
            <div class="flex justify-end msg-appear msg-row">
              <div class="bubble bubble-outgoing">
                <div class="text-sm break-words">{{ msg.message }}</div>
                <div class="text-[11px] mt-1 opacity-80 text-right">{{ msg.created_at|time:"H:i" }}</div>
              </div>
            </div>
          {% else %}
            <div class="flex items-start gap-3 msg-appear msg-row">
              <div class="flex-shrink-0 mt-1">
                <div class="h-8 w-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-700 font-medium">
                  {{ msg.sender.username|first|upper }}
                </div>
              </div>
              <div class="bubble bubble-incoming">
                <div class="text-sm font-medium mb-1">{{ msg.sender.username }}</div>
                <div class="text-sm break-words">{{ msg.message }}</div>
                <div class="text-[11px] mt-1 text-gray-500">{{ msg.created_at|time:"H:i" }}</div>
              </div>
            </div>
          {% endif %}
        {% empty %}
          <div class="text-center text-gray-500 mt-12">Немає повідомлень — почніть діалог</div>
        {% endfor %}
      </main>

      <footer class="border-t bg-white px-4 py-3">
        <div class="max-w-3xl mx-auto flex items-center gap-3">
          <input id="msg-input" type="text" placeholder="Написати повідомлення..."
                 class="flex-1 border rounded-full px-4 text-sm focus:outline-none focus:ring-2 focus:ring-sky-200 chat-input" />

          <button id="send-btn" class="bg-[#0095f6] hover:bg-[#0084e6] text-white rounded-full btn-send" aria-label="Відправити">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="h-5 w-5">
              <path fill="#ffffff" d="M568.4 37.7C578.2 34.2 589 36.7 596.4 44C603.8 51.3 606.2 62.2 602.7 72L424.7 568.9C419.7 582.8 406.6 592 391.9 592C377.7 592 364.9 583.4 359.6 570.3L295.4 412.3C290.9 401.3 292.9 388.7 300.6 379.7L395.1 267.3C400.2 261.2 399.8 252.3 394.2 246.7C388.6 241.1 379.6 240.7 373.6 245.8L261.2 340.1C252.1 347.7 239.6 349.7 228.6 345.3L70.1 280.8C57 275.5 48.4 262.7 48.4 248.5C48.4 233.8 57.6 220.7 71.5 215.7L568.4 37.7z"/></svg>
          </button>
        </div>
      </footer>
    </div>
  </div>

<script>
(function () {
  const DIRECT_ID = "{{ direct.id }}";
  const USER_ID = Number("{{ request.user.id }}");
  let currentPage = Number("{{ current_page }}") || 1;
  const numPages = Number("{{ num_pages }}") || 1;

  const chatWindow = document.getElementById('chat-window');
  const sendBtn = document.getElementById('send-btn');
  const msgInput = document.getElementById('msg-input');

  function escapeHtml(unsafe = '') {
    return String(unsafe)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function scrollToBottom() {
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function createMessageElement({ message, created_time, sender_id, sender_username = null }) {
    const isOwn = Number(sender_id) === USER_ID;
    const wrapper = document.createElement('div');
    wrapper.classList.add('msg-appear');

    wrapper.classList.add('flex', isOwn ? 'justify-end' : 'justify-start');

    const bubbleClass = isOwn ? 'bubble-outgoing' : 'bubble-incoming';

    const senderHtml = (!isOwn && sender_username)
      ? `<div class="text-sm font-medium mb-1">${escapeHtml(sender_username)}</div>`
      : '';

    wrapper.innerHTML = `
      <div class="bubble ${bubbleClass} max-w-xs break-words p-2 rounded-lg">
        ${senderHtml}
        <div class="text-sm break-words">${escapeHtml(message)}</div>
        <div class="text-[11px] mt-1 ${isOwn ? 'text-gray-100 text-right' : 'text-gray-500'}">${escapeHtml(created_time || '')}</div>
      </div>
    `;
    return wrapper;
  }

  const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const wsUrl = `${protocol}://${window.location.host}/ws/direct/${DIRECT_ID}/`;
  const socket = new WebSocket(wsUrl);

  socket.addEventListener('message', (e) => {
    try {
      const data = JSON.parse(e.data);
      const node = createMessageElement({
        message: data.message,
        created_time: (new Date()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        sender_id: data.sender_id,
        sender_username: data.sender_username || null
      });
      chatWindow.appendChild(node);
      scrollToBottom();
    } catch (err) {
      console.error('WS message handling error', err);
    }
  });

  socket.addEventListener('close', () => {
    console.warn('WS closed');
  });

  function sendMessage() {
    const value = msgInput.value.trim();
    if (!value) return;
    if (socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({ message: value }));
      msgInput.value = '';
    } else {
      console.warn('WebSocket is not open');
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  msgInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  let loading = false;

  chatWindow.addEventListener('scroll', async () => {
    if (chatWindow.scrollTop > 50) return;
    if (loading) return;
    if (currentPage <= 1) return;

    loading = true;
    const prevScrollHeight = chatWindow.scrollHeight;
    const nextPage = currentPage - 1;

    try {
      const resp = await fetch(`messages/?page=${nextPage}`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      if (!resp.ok) throw new Error('Network error');

      const payload = await resp.json();
      const msgs = payload.messages || [];

      const frag = document.createDocumentFragment();
      for (let i = 0; i < msgs.length; i++) {
        const m = msgs[i];
        const node = createMessageElement({
          message: m.message,
          created_time: m.created_time,
          sender_id: m.sender_id,
          sender_username: m.sender_username || null
        });
        frag.appendChild(node);
      }

      chatWindow.insertBefore(frag, chatWindow.firstChild);

      const newScrollHeight = chatWindow.scrollHeight;
      chatWindow.scrollTop = newScrollHeight - prevScrollHeight;

      currentPage = payload.page;
    } catch (err) {
      console.error('Error loading older messages', err);
    } finally {
      loading = false;
    }
  });

  setTimeout(scrollToBottom, 50);
})();
</script>
</body>
</html>
